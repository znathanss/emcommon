---
stages:
  - build
  - test
  - push


build3:
  stage: build
  image: python:3
  script:
    - pip3 install --upgrade pip
    - pip3 install build twine
    - python3 -m build
  artifacts:
    paths:
      - dist
    expire_in: 7d
  
build2:
  stage: build
  image: python:2
  script:
    - pip install --upgrade pip
    - pip install build twine
    - python -m build
  artifacts:
    paths:
      - dist
    expire_in: 7d


test3:
  stage: test
  when: on_success
  image: python:3
  script:
    - pip3 install --upgrade pip
    - pip3 install .
    - pip3 install pytest
    - pytest


test2:
  stage: test
  when: on_success
  image: python:2
  script:
    - pip install --upgrade pip
    - pip install .
    - pip install pytest
    - pytest


push:
  stage: push
  when: manual
  image: python:3
  script:
    - pip3 install --upgrade pip
    - pip3 install twine
    - python3 -m twine upload --repository testpypi dist/* --username __token__ --password $PYPI_API_KEY